
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>1. Data wrangling &#8212; mcmodels 0.0.1 documentation</title>
    <link rel="stylesheet" href="../_static/aibs_sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2. Regressors" href="../regressors.html" />
    <link rel="prev" title="User Guide" href="../user_guide.html" /> 
  </head>
  <body>
<link rel="stylesheet" type="text/css" href="../_static/external_assets/stylesheets/common_layout.css" />
<link rel="stylesheet" type="text/css" href="../_static/external_assets/stylesheets/animation.css" /> 
<script src="../_static/external_assets/bundled.js" type="text/javascript"></script> 

<script type="text/javascript"> 
    document.addEventListener("DOMContentLoaded", function() { 
        if(typeof PortalAssets !== 'undefined')
            PortalAssets.initializePortal({
                tabId: 'Data'
            });
    });
</script>


  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="data-wrangling">
<span id="id1"></span><h1>1. Data wrangling<a class="headerlink" href="#data-wrangling" title="Permalink to this headline">¶</a></h1>
<div class="section" id="working-with-data-from-the-allensdk">
<span id="allen-data"></span><h2>1.1. Working with data from the <a class="reference external" href="https://alleninstitute.github.io/AllenSDK/">AllenSDK</a><a class="headerlink" href="#working-with-data-from-the-allensdk" title="Permalink to this headline">¶</a></h2>
<p>The data we use in our connectivity models comes from the AAV tracing experiments
performed at the Allen Institute for Brain Science. The experiments consist of
injecting an AAV viral tracer into a region of the mouse brain and subsequently
imaging the brain after the virus has propagated down the axons of the infected
neurons. This imaging reveals how a group of infected neurons are structurally
connected to other regions of the brain.</p>
<div class="section" id="allensdk-package">
<h3>1.1.1. <a class="reference external" href="https://alleninstitute.github.io/AllenSDK/">AllenSDK</a> Package<a class="headerlink" href="#allensdk-package" title="Permalink to this headline">¶</a></h3>
<p>allensdk is a python package provided by the Allen Institute to allow for
retrieval and manipulation of the data generated by the experiments they perform.
We utilize the <a class="reference internal" href="classes.html#module-mcmodels.core" title="mcmodels.core"><code class="xref py py-mod docutils literal"><span class="pre">mcmodels.core</span></code></a> subpackage which supports the data service of the
previously mentioned viral tracing experiments. Specifically, we incorporate
the <a class="reference external" href="http://alleninstitute.github.io/AllenSDK/allensdk.core.html#allensdk.core.mouse_connectivity_cache.MouseConnectivityCache">allensdk.core.MouseConnectivityCache</a> object to pull experimental data
as well as register the data in the Allen 3D Reference Space. More information
can be found <a class="reference external" href="http://alleninstitute.github.io/AllenSDK/connectivity.html">here</a></p>
</div>
</div>
<div class="section" id="core-package">
<h2>1.2. Core Package<a class="headerlink" href="#core-package" title="Permalink to this headline">¶</a></h2>
<div class="section" id="voxelmodelcache">
<h3>1.2.1. <a class="reference internal" href="generated/mcmodels.core.VoxelModelCache.html#mcmodels.core.VoxelModelCache" title="mcmodels.core.VoxelModelCache"><code class="xref py py-class docutils literal"><span class="pre">VoxelModelCache</span></code></a><a class="headerlink" href="#voxelmodelcache" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="generated/mcmodels.core.VoxelModelCache.html#mcmodels.core.VoxelModelCache" title="mcmodels.core.VoxelModelCache"><code class="xref py py-class docutils literal"><span class="pre">VoxelModelCache</span></code></a> extends <a class="reference external" href="http://alleninstitute.github.io/AllenSDK/allensdk.core.html#allensdk.core.mouse_connectivity_cache.MouseConnectivityCache">allensdk.core.MouseConnectivityCache</a> to download
and pull the latest iteration of our <a class="reference internal" href="../glossary.html#term-voxel-model"><span class="xref std std-term">voxel model</span></a>. Additionally, this
class implements the <a class="reference internal" href="generated/mcmodels.core.VoxelModelCache.html#mcmodels.core.VoxelModelCache.get_experiment_data" title="mcmodels.core.VoxelModelCache.get_experiment_data"><code class="xref py py-meth docutils literal"><span class="pre">get_experiment_data</span></code></a> to pull
experiment <span class="xref std std-term">injection</span> and <span class="xref std std-term">projection</span> volumes given that the
experiment satisfies all supplied parameters</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">mcmodels.core</span> <span class="k">import</span> <span class="n">VoxelModelCache</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span> <span class="o">=</span> <span class="n">VoxelModelCache</span><span class="p">(</span><span class="n">manifest_file</span><span class="o">=</span><span class="s1">&#39;connectivity/voxel_model_manifest.json&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># download and cache the latest voxel model</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># this method returns a tuple with object types:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># (VoxelConnectivityArray, Mask, Mask)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">voxel_array</span><span class="p">,</span> <span class="n">source_mask</span><span class="p">,</span> <span class="n">target_mask</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_voxel_connectivity_array</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># download and cache a regionalized voxel model</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">normalized_connection_density</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_normalized_connection_density</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># get all wildtype, cortical experiment data</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># this method returns a VoxelData object</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cortex_data</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_experiment_data</span><span class="p">(</span><span class="n">injection_structure_ids</span><span class="o">=</span><span class="p">[</span><span class="mi">315</span><span class="p">],</span> <span class="n">cre</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="generated/mcmodels.core.VoxelModelCache.html#mcmodels.core.VoxelModelCache" title="mcmodels.core.VoxelModelCache"><code class="xref py py-class docutils literal"><span class="pre">VoxelModelCache</span></code></a> and <a class="reference internal" href="generated/mcmodels.core.VoxelData.html#mcmodels.core.VoxelData" title="mcmodels.core.VoxelData"><code class="xref py py-class docutils literal"><span class="pre">VoxelData</span></code></a> for more information.</p>
</div>
<div class="section" id="mask-class">
<h3>1.2.2. <a class="reference internal" href="generated/mcmodels.core.Mask.html#mcmodels.core.Mask" title="mcmodels.core.Mask"><code class="xref py py-class docutils literal"><span class="pre">Mask</span></code></a> class<a class="headerlink" href="#mask-class" title="Permalink to this headline">¶</a></h3>
<p>In our package, we define methods relating to registering data into the 3D
reference space in our <a class="reference internal" href="generated/mcmodels.core.Mask.html#mcmodels.core.Mask" title="mcmodels.core.Mask"><code class="xref py py-class docutils literal"><span class="pre">Mask</span></code></a> class. Specifically, we can:</p>
<ul class="simple">
<li>query only specific structures of the brain</li>
<li>map masked vectors of the brain back to their corresponding locations in the
3D reference space.</li>
<li>determine to which structure each element of a masked vector belongs</li>
</ul>
<p><a class="reference internal" href="generated/mcmodels.core.Mask.html#mcmodels.core.Mask" title="mcmodels.core.Mask"><code class="xref py py-class docutils literal"><span class="pre">Mask</span></code></a> is most often initialized through the <a class="reference internal" href="generated/mcmodels.core.Mask.html#mcmodels.core.Mask.from_cache" title="mcmodels.core.Mask.from_cache"><code class="xref py py-meth docutils literal"><span class="pre">Mask.from_cache</span></code></a>
classmethod using a <a class="reference internal" href="generated/mcmodels.core.VoxelModelCache.html#mcmodels.core.VoxelModelCache" title="mcmodels.core.VoxelModelCache"><code class="xref py py-class docutils literal"><span class="pre">VoxelModelCache</span></code></a> object
and optional keyword arguments for subetting either hemispheres or structures. In the case of
the new <a class="reference internal" href="voxel.html#voxel"><span class="std std-ref">voxel scale model</span></a>, we define the source to be right hemisphere,
and in this case the cortex:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">mcmodels.core</span> <span class="k">import</span> <span class="n">Mask</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">source_mask</span> <span class="o">=</span> <span class="n">Mask</span><span class="o">.</span><span class="n">from_cache</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">hemisphere</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">structure_ids</span><span class="o">=</span><span class="p">[</span><span class="mi">315</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">source_mask</span>
<span class="go">Mask(hemisphere_id=2, structure_ids=[315])</span>
</pre></div>
</div>
<p>The method <a class="reference internal" href="generated/mcmodels.core.VoxelData.html#mcmodels.core.VoxelData.get_experiment_data" title="mcmodels.core.VoxelData.get_experiment_data"><code class="xref py py-meth docutils literal"><span class="pre">get_experiment_data</span></code></a> in <code class="xref py py-class docutils literal"><span class="pre">VoxelModelData</span></code> or <a class="reference internal" href="generated/mcmodels.core.VoxelData.html#mcmodels.core.VoxelData" title="mcmodels.core.VoxelData"><code class="xref py py-class docutils literal"><span class="pre">VoxelData</span></code></a>
sets source and target matrices as attributes which have masked, flattened
injection and projection volumes for each experiment as rows. One can determine
the structure_id of a given column in either of these arrays using the method
<a class="reference internal" href="generated/mcmodels.core.Mask.html#mcmodels.core.Mask.get_key" title="mcmodels.core.Mask.get_key"><code class="xref py py-meth docutils literal"><span class="pre">get_key</span></code></a> from the <a class="reference internal" href="generated/mcmodels.core.Mask.html#mcmodels.core.Mask" title="mcmodels.core.Mask"><code class="xref py py-class docutils literal"><span class="pre">Mask</span></code></a> object:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span> <span class="o">=</span> <span class="n">source_mask</span><span class="o">.</span><span class="n">get_key</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span><span class="o">.</span><span class="n">shape</span>
<span class="go">xxxx</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="go">np.array([315])</span>
</pre></div>
</div>
<p>The key by default will include only the structure ids specified in the
construction of the <a class="reference internal" href="generated/mcmodels.core.Mask.html#mcmodels.core.Mask" title="mcmodels.core.Mask"><code class="xref py py-class docutils literal"><span class="pre">Mask</span></code></a> object. However, we can pass specific
<code class="docutils literal"><span class="pre">structure_ids</span></code> to the <a class="reference internal" href="generated/mcmodels.core.Mask.html#mcmodels.core.Mask.get_key" title="mcmodels.core.Mask.get_key"><code class="xref py py-meth docutils literal"><span class="pre">get_key</span></code></a> method if we are interested in a finer or
coarser level in the ontology</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># get set of summary structures</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">structure_tree</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_structure_tree</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">summary_structures</span> <span class="o">=</span> <span class="n">structure_tree</span><span class="o">.</span><span class="n">get_structures_by_set_id</span><span class="p">([</span><span class="mi">165787189</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># the new ccf does not have sturcture 934 as a structure id</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">structure_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">summary_structures</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">934</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span> <span class="o">=</span> <span class="n">source_mask</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">structure_ids</span><span class="o">=</span><span class="n">structure_ids</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
<span class="go">293</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">key</span></code> array has length equal to the number of <a class="reference internal" href="../glossary.html#term-voxels"><span class="xref std std-term">voxels</span></a> in the cortex (R
hemisphere) as that is the definition of our <code class="docutils literal"><span class="pre">mask</span></code>. However, if we just want
the indices for a given structure:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># get sturcture id correponding to VISp</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">visp_id</span> <span class="o">=</span> <span class="n">structure_tree</span><span class="o">.</span><span class="n">get_structures_by_acronym</span><span class="p">([</span><span class="s2">&quot;VISp&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">visp_idx</span> <span class="o">=</span> <span class="n">source_mask</span><span class="o">.</span><span class="n">get_structure_indices</span><span class="p">(</span><span class="n">structure_ids</span><span class="o">=</span><span class="p">[</span><span class="n">visp_id</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">visp_idx</span><span class="p">)</span>
<span class="go">xxx</span>
</pre></div>
</div>
<p>Given a masked injection/projection volume (a row in the source or target arrays)
one can map the flattened vector back to the 3D reference space:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># our key is a masked, flattened volume, lets map it back</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key_volume</span> <span class="o">=</span> <span class="n">source_mask</span><span class="o">.</span><span class="n">map_masked_to_annotation</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key_volume</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(132, 80, 114)</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../index.html">Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="classes.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whats_new.html">Release history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contrubuting</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/AllenInstitute/mouse_connectivity_models.git">Github Profile</a></li>
</ul>

<h3> Questions </h3>
<p class="questions">
  Send any questions using the <a href="http://alleninstitute.org/contact_us/index.html">Send Us a Message</a> link below, 
  or submit your question to <a href="http://stackoverflow.com/">StackOverflow</a> using with the 'allen-sdk' tag.
</p>

<p class="questions">
  If you encounter any problems using the AllenSDK, please create an issue on <a href="http://github.com/alleninstitute/allensdk/issues/">Github's issue tracker</a>.
</p>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>


    <div class="footer" role="contentinfo">
        &#169; Copyright 2018. Allen Institute..
    </div> 

  </body>
</html>