
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>mcmodels.core.base &#8212; mcmodels 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/aibs_sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head>
  <body>
<link rel="stylesheet" type="text/css" href="../../../_static/external_assets/stylesheets/common_layout.css" />
<link rel="stylesheet" type="text/css" href="../../../_static/external_assets/stylesheets/animation.css" /> 
<script src="../../../_static/external_assets/bundled.js" type="text/javascript"></script> 

<script type="text/javascript"> 
    document.addEventListener("DOMContentLoaded", function() { 
        if(typeof PortalAssets !== 'undefined')
            PortalAssets.initializePortal({
                tabId: 'Data'
            });
    });
</script>


  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for mcmodels.core.base</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module containing VoxelData and RegionalData objects.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Authors: Joseph Knox &lt;josephk@alleninstitute.org&gt;</span>
<span class="c1"># License: Allen Institute Software License</span>

<span class="c1"># TODO: implement __repr__</span>
<span class="c1"># TODO: integrate into VoxelModelCache</span>

<span class="kn">from</span> <span class="nn">abc</span> <span class="k">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span><span class="p">,</span> <span class="n">abstractproperty</span>

<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.experiment</span> <span class="k">import</span> <span class="n">Experiment</span>
<span class="kn">from</span> <span class="nn">.masks</span> <span class="k">import</span> <span class="n">Mask</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="k">import</span> <span class="n">unionize</span>


<span class="k">class</span> <span class="nc">_BaseData</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">ABCMeta</span><span class="p">)):</span>

    <span class="nd">@abstractproperty</span>
    <span class="k">def</span> <span class="nf">DEFAULT_STRUCTURE_SET_IDS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; for default structure ids &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_structure_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default structure ids.&quot;&quot;&quot;</span>
        <span class="c1"># NOTE: Necessary copy from allensdk.core.MouseConnectivityCache because</span>
        <span class="c1">#       of hardcoded class and summary structure set id error due to</span>
        <span class="c1">#       new annotation (ccf)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_default_structure_ids&#39;</span><span class="p">):</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_structure_tree</span><span class="p">()</span>
            <span class="n">default_structures</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">get_structures_by_set_id</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_STRUCTURE_SET_IDS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default_structure_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">default_structures</span>
                                           <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">934</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_structure_ids</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">cache</span><span class="p">,</span>
                 <span class="n">injection_structure_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">projection_structure_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">injection_hemisphere_id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">projection_hemisphere_id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">normalized_injection</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">normalized_projection</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">flip_experiments</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">data_mask_tolerance</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">injection_volume_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
                 <span class="n">projection_volume_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
                 <span class="n">min_contained_injection_ratio</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">injection_structure_ids</span> <span class="o">=</span> <span class="n">injection_structure_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projection_structure_ids</span> <span class="o">=</span> <span class="n">projection_structure_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">injection_hemisphere_id</span> <span class="o">=</span> <span class="n">injection_hemisphere_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projection_hemisphere_id</span> <span class="o">=</span> <span class="n">projection_hemisphere_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_injection</span> <span class="o">=</span> <span class="n">normalized_injection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_projection</span> <span class="o">=</span> <span class="n">normalized_projection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flip_experiments</span> <span class="o">=</span> <span class="n">flip_experiments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_mask_tolerance</span> <span class="o">=</span> <span class="n">data_mask_tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">injection_volume_bounds</span> <span class="o">=</span> <span class="n">injection_volume_bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projection_volume_bounds</span> <span class="o">=</span> <span class="n">projection_volume_bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_contained_injection_ratio</span> <span class="o">=</span> <span class="n">min_contained_injection_ratio</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">injection_structure_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">injection_structure_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_structure_ids</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_structure_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projection_structure_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_structure_ids</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">injection_mask</span> <span class="o">=</span> <span class="n">Mask</span><span class="o">.</span><span class="n">from_cache</span><span class="p">(</span>
            <span class="n">cache</span><span class="p">,</span>
            <span class="n">structure_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">injection_structure_ids</span><span class="p">,</span>
            <span class="n">hemisphere_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">injection_hemisphere_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projection_mask</span> <span class="o">=</span> <span class="n">Mask</span><span class="o">.</span><span class="n">from_cache</span><span class="p">(</span>
            <span class="n">cache</span><span class="p">,</span>
            <span class="n">structure_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projection_structure_ids</span><span class="p">,</span>
            <span class="n">hemisphere_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projection_hemisphere_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: update to show parameters</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_experiment_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_ids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates experiment objections given their experiment ids&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">valid_volume</span><span class="p">(</span><span class="n">experiment</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Does experiment meet volume requirements?&quot;&quot;&quot;</span>
            <span class="c1"># compute injection ratio contained within injection mask</span>
            <span class="n">contained_injection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">injection_mask</span><span class="o">.</span><span class="n">mask_volume</span><span class="p">(</span>
                <span class="n">experiment</span><span class="o">.</span><span class="n">injection_density</span><span class="p">)</span>
            <span class="n">contained_ratio</span> <span class="o">=</span> <span class="n">contained_injection</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">experiment</span><span class="o">.</span><span class="n">injection_volume</span>

            <span class="c1"># convert to mm^3</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_reference_space</span><span class="p">()</span><span class="o">.</span><span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">convert</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1e-3</span> <span class="o">*</span> <span class="n">resolution</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>

            <span class="n">injection_volume</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">injection_volume</span><span class="p">)</span>
            <span class="n">projection_volume</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">projection_volume</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">injection_volume</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">injection_volume_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span>
                    <span class="n">injection_volume</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">injection_volume_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
                    <span class="n">projection_volume</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_volume_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span>
                    <span class="n">projection_volume</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_volume_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
                    <span class="n">contained_ratio</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_contained_injection_ratio</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="n">experiment_ids</span><span class="p">:</span>
            <span class="n">experiment</span> <span class="o">=</span> <span class="n">Experiment</span><span class="o">.</span><span class="n">from_cache</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_mask_tolerance</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">valid_volume</span><span class="p">(</span><span class="n">experiment</span><span class="p">):</span>
                <span class="n">hemisphere_id</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">injection_hemisphere_id</span>

                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">injection_hemisphere_id</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span>
                        <span class="n">hemisphere_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">injection_hemisphere_id</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">experiment</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">flip_experiments</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">experiment</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_experiment_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_ids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;forms data arrays, returns self&quot;&quot;&quot;</span>


<div class="viewcode-block" id="VoxelData"><a class="viewcode-back" href="../../../modules/generated/mcmodels.core.VoxelData.html#mcmodels.core.VoxelData">[docs]</a><span class="k">class</span> <span class="nc">VoxelData</span><span class="p">(</span><span class="n">_BaseData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container class for voxel-scale grid data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cache - VoxelModelCache or MouseConnectivityCache object</span>
<span class="sd">        Provides way to pull experiment grid-data from Allen Brain Atlas</span>

<span class="sd">    injection_structure_ids : list, optional, default None</span>
<span class="sd">        List of structure_ids to which the injection mask will be constrained.</span>

<span class="sd">    projection_structure_ids : list, optional, default None</span>
<span class="sd">        List of structure_ids to which the projection mask will be constrained.</span>

<span class="sd">    injection_hemisphere_id : int, optional, default 3</span>
<span class="sd">        Hemisphere (1:left, 2:right, 3:both) to which the injection mask will</span>
<span class="sd">        be constrained.</span>

<span class="sd">    projection_hemisphere_id : int, optional, default 3</span>
<span class="sd">        Hemisphere (1:left, 2:right, 3:both) to which the projection mask will</span>
<span class="sd">        be constrained.</span>

<span class="sd">    normalized_injection : boolean, optional, default True</span>
<span class="sd">        If True, the injection density will be normalized by the total</span>
<span class="sd">        injection density for each experiment.</span>

<span class="sd">    normalized_projection : boolean, optional, default True</span>
<span class="sd">        If True, the projection density will be normalized by the total</span>
<span class="sd">        injection density for each experiment.</span>

<span class="sd">    flip_experiments : boolean, optional, default True</span>
<span class="sd">        If True, experiment grid-data will be refelcted accross the midline.</span>
<span class="sd">        Useful if you wish to include L hemisphere injections into a R</span>
<span class="sd">        hemisphere model.</span>

<span class="sd">    data_mask_tolerance : float, optional, default 0.0</span>
<span class="sd">        Tolerance with which to include data in voxels informatically labeled</span>
<span class="sd">        as having error. The data_mask for each experiment is an array with</span>
<span class="sd">        values between (0, 1), where 1 indicates the voxel fully contains an</span>
<span class="sd">        error, whereas 0 indicates the voxel does not contain any error. A value</span>
<span class="sd">        of 0.0 thus indicates the highest threshold for data, whereas a value of</span>
<span class="sd">        1.0 indicates that data will be included from all voxels.</span>

<span class="sd">    injection_volume_bounds : float, optional, default (0.0, np.inf)</span>
<span class="sd">        Includes experiments with total injection volume (mm^3) within bounds.</span>

<span class="sd">    projection_volume_bounds : float, optional, default (0.0, np.inf)</span>
<span class="sd">        Includes experiments with total projection volume (mm^3) within bounds.</span>

<span class="sd">    min_contained_injection_ratio : float, optional, default 0.0</span>
<span class="sd">        Includes experiments with total injection volume ratio within injection</span>
<span class="sd">        mask.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    injection_mask : Mask object</span>
<span class="sd">        Mask object used to constrain and flatten the injection_density from</span>
<span class="sd">        each experiment. This object can also be used to generate a key relating</span>
<span class="sd">        each column of the injections matrix to a corresponding structure or to</span>
<span class="sd">        transform a given row of the injections matrix to its corresponding</span>
<span class="sd">        brain volume.</span>

<span class="sd">    projection_mask : Mask object</span>
<span class="sd">        Mask object used to constrain and flatten the projection_density from</span>
<span class="sd">        each experiment. This object can also be used to generate a key relating</span>
<span class="sd">        each column of the projections matrix to a corresponding structure or to</span>
<span class="sd">        transform a given row of the projections matrix to its corresponding</span>
<span class="sd">        brain volume.</span>

<span class="sd">    centroids : array, shape (n_experiments, 3)</span>
<span class="sd">        Stacked array of injection centroids for each experiment.</span>

<span class="sd">    injections : array, shape (n_experiments, n_source_voxels)</span>
<span class="sd">        Stacked array of constrained, flattened injection densities for each</span>
<span class="sd">        experiment.</span>

<span class="sd">    projections : array, shape (n_experiments, n_target_voxels)</span>
<span class="sd">        Stacked array of constrained, flattened projection densities for each</span>
<span class="sd">        experiment.</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    RegionalData</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from mcmodels.core import VoxelData, VoxelModelCache</span>
<span class="sd">    &gt;&gt;&gt; cache = VoxelModelCache()</span>
<span class="sd">    &gt;&gt;&gt; experiment_ids = (112514202, 139520203)</span>
<span class="sd">    &gt;&gt;&gt; voxel_data = VoxelData(cache)</span>
<span class="sd">    &gt;&gt;&gt; voxel_data.get_experiment_data(experiment_ids)</span>
<span class="sd">    VoxelData()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">COARSE_STRUCTURE_SET_ID</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">DEFAULT_STRUCTURE_SET_IDS</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">COARSE_STRUCTURE_SET_ID</span><span class="p">])</span>

<div class="viewcode-block" id="VoxelData.get_experiment_data"><a class="viewcode-back" href="../../../modules/generated/mcmodels.core.VoxelData.html#mcmodels.core.VoxelData.get_experiment_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_experiment_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_ids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pulls voxel-scale grid data for experiments.</span>

<span class="sd">        Uses the cache property to pull grid data from the Allen Brain Atlas.</span>
<span class="sd">        Note that only experiments passing all defined parameters will be</span>
<span class="sd">        included.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        experiment_ids : list</span>
<span class="sd">            Ids of candidate experiments to pull. Only the subset of these</span>
<span class="sd">            experiments passing user defined object parameters will be pulled.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : returns an instance of self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">get_centroid</span><span class="p">(</span><span class="n">experiment</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Returns experiment centroid&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">experiment</span><span class="o">.</span><span class="n">centroid</span>

        <span class="k">def</span> <span class="nf">get_injection</span><span class="p">(</span><span class="n">experiment</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Returns experiment injection masked &amp; flattened&quot;&quot;&quot;</span>
            <span class="n">injection</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">get_injection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_injection</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">injection_mask</span><span class="o">.</span><span class="n">mask_volume</span><span class="p">(</span><span class="n">injection</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_projection</span><span class="p">(</span><span class="n">experiment</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Returns experiment projection masked &amp; flattened&quot;&quot;&quot;</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">get_projection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_projection</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_mask</span><span class="o">.</span><span class="n">mask_volume</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

        <span class="c1"># get data</span>
        <span class="n">get_data</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">get_centroid</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                              <span class="n">get_injection</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                              <span class="n">get_projection</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">get_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiment_generator</span><span class="p">(</span><span class="n">experiment_ids</span><span class="p">))</span>

        <span class="n">centroids</span><span class="p">,</span> <span class="n">injections</span><span class="p">,</span> <span class="n">projections</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">arrays</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">centroids</span> <span class="o">=</span> <span class="n">centroids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">injections</span> <span class="o">=</span> <span class="n">injections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projections</span> <span class="o">=</span> <span class="n">projections</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="VoxelData.get_regional_data"><a class="viewcode-back" href="../../../modules/generated/mcmodels.core.VoxelData.html#mcmodels.core.VoxelData.get_regional_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_regional_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns RegionalData object with same parameters.&quot;&quot;&quot;</span>
        <span class="n">regional_data</span> <span class="o">=</span> <span class="n">RegionalData</span><span class="o">.</span><span class="n">from_voxel_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;centroids&#39;</span><span class="p">):</span>
            <span class="c1"># unionize pulled data</span>
            <span class="n">regional_data</span><span class="o">.</span><span class="n">centroids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centroids</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">regional_data</span><span class="o">.</span><span class="n">injections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">injections</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">regional_data</span><span class="o">.</span><span class="n">projections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># NOTE: a little hacky :: accessing private method outside class</span>
            <span class="n">regional_data</span><span class="o">.</span><span class="n">_unionize_experiment_data</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">regional_data</span></div></div>


<div class="viewcode-block" id="RegionalData"><a class="viewcode-back" href="../../../modules/generated/mcmodels.core.RegionalData.html#mcmodels.core.RegionalData">[docs]</a><span class="k">class</span> <span class="nc">RegionalData</span><span class="p">(</span><span class="n">VoxelData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container class for regionalized voxel-scale grid data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cache - VoxelModelCache or MouseConnectivityCache object</span>
<span class="sd">        Provides way to pull experiment grid-data from Allen Brain Atlas</span>

<span class="sd">    injection_structure_ids : list, optional, default None</span>
<span class="sd">        List of structure_ids to which the injection mask will be constrained.</span>

<span class="sd">    projection_structure_ids : list, optional, default None</span>
<span class="sd">        List of structure_ids to which the projection mask will be constrained.</span>

<span class="sd">    injection_hemisphere_id : int, optional, default 3</span>
<span class="sd">        Hemisphere (1:left, 2:right, 3:both) to which the injection mask will</span>
<span class="sd">        be constrained.</span>

<span class="sd">    projection_hemisphere_id : int, optional, default 3</span>
<span class="sd">        Hemisphere (1:left, 2:right, 3:both) to which the projection mask will</span>
<span class="sd">        be constrained.</span>

<span class="sd">    normalized_injection : boolean, optional, default True</span>
<span class="sd">        If True, the injection density will be normalized by the total</span>
<span class="sd">        injection density for each experiment.</span>

<span class="sd">    normalized_projection : boolean, optional, default True</span>
<span class="sd">        If True, the projection density will be normalized by the total</span>
<span class="sd">        injection density for each experiment.</span>

<span class="sd">    flip_experiments : boolean, optional, default True</span>
<span class="sd">        If True, experiment grid-data will be reflected across the midline.</span>
<span class="sd">        Useful if you wish to include L hemisphere injections into a R</span>
<span class="sd">        hemisphere model.</span>

<span class="sd">    data_mask_tolerance : float, optional, default 0.0</span>
<span class="sd">        Tolerance with which to include data in voxels informatically labeled</span>
<span class="sd">        as having error. The data_mask for each experiment is an array with</span>
<span class="sd">        values between (0, 1), where 1 indicates the voxel fully contains an</span>
<span class="sd">        error, whereas 0 indicates the voxel does not contain any error. A value</span>
<span class="sd">        of 0.0 thus indicates the highest threshold for data, whereas a value of</span>
<span class="sd">        1.0 indicates that data will be included from all voxels.</span>

<span class="sd">    injection_volume_bounds : float, optional, default (0.0, np.inf)</span>
<span class="sd">        Includes experiments with total injection volume (mm^3) within bounds.</span>

<span class="sd">    projection_volume_bounds : float, optional, default (0.0, np.inf)</span>
<span class="sd">        Includes experiments with total projection volume (mm^3) within bounds.</span>

<span class="sd">    min_contained_injection_ratio : float, optional, default 0.0</span>
<span class="sd">        Includes experiments with total injection volume ratio within injection</span>
<span class="sd">        mask.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    injection_mask : Mask object</span>
<span class="sd">        Mask object used to constrain and flatten the injection_density from</span>
<span class="sd">        each experiment. This object can also be used to generate a key relating</span>
<span class="sd">        each column of the injections matrix to a corresponding structure or to</span>
<span class="sd">        transform a given row of the injections matrix to its corresponding</span>
<span class="sd">        brain volume.</span>

<span class="sd">    projection_mask : Mask object</span>
<span class="sd">        Mask object used to constrain and flatten the projection_density from</span>
<span class="sd">        each experiment. This object can also be used to generate a key relating</span>
<span class="sd">        each column of the projections matrix to a corresponding structure or to</span>
<span class="sd">        transform a given row of the projections matrix to its corresponding</span>
<span class="sd">        brain volume.</span>

<span class="sd">    centroids : array, shape (n_experiments, 3)</span>
<span class="sd">        Stacked array of injection centroids for each experiment.</span>

<span class="sd">    injections : array, shape (n_experiments, n_source_regions)</span>
<span class="sd">        Stacked array of constrained, flattened injection densities for each</span>
<span class="sd">        experiment.</span>

<span class="sd">    projections : array, shape (n_experiments, n_target_regions)</span>
<span class="sd">        Stacked array of constrained, flattened projection densities for each</span>
<span class="sd">        experiment.</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    VoxelData</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from mcmodels.core import RegionalData, VoxelModelCache</span>
<span class="sd">    &gt;&gt;&gt; cache = VoxelModelCache()</span>
<span class="sd">    &gt;&gt;&gt; experiment_ids = (112514202, 139520203)</span>
<span class="sd">    &gt;&gt;&gt; regional_data = RegionalData(cache)</span>
<span class="sd">    &gt;&gt;&gt; regional_data.get_experiment_data(experiment_ids)</span>
<span class="sd">    RegionalData()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUMMARY_STRUCTURE_SET_ID</span> <span class="o">=</span> <span class="mi">167587189</span>
    <span class="n">DEFAULT_STRUCTURE_SET_IDS</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">SUMMARY_STRUCTURE_SET_ID</span><span class="p">])</span>

<div class="viewcode-block" id="RegionalData.from_voxel_data"><a class="viewcode-back" href="../../../modules/generated/mcmodels.core.RegionalData.html#mcmodels.core.RegionalData.from_voxel_data">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_voxel_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">voxel_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct class from a VoxelData object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        voxel_data : a VoxelData object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RegionalData : an installation of the RegionalData object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">voxel_data</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span>
                   <span class="n">injection_structure_ids</span><span class="o">=</span><span class="n">voxel_data</span><span class="o">.</span><span class="n">injection_structure_ids</span><span class="p">,</span>
                   <span class="n">projection_structure_ids</span><span class="o">=</span><span class="n">voxel_data</span><span class="o">.</span><span class="n">projection_structure_ids</span><span class="p">,</span>
                   <span class="n">injection_hemisphere_id</span><span class="o">=</span><span class="n">voxel_data</span><span class="o">.</span><span class="n">injection_hemisphere_id</span><span class="p">,</span>
                   <span class="n">projection_hemisphere_id</span><span class="o">=</span><span class="n">voxel_data</span><span class="o">.</span><span class="n">projection_hemisphere_id</span><span class="p">,</span>
                   <span class="n">normalized_injection</span><span class="o">=</span><span class="n">voxel_data</span><span class="o">.</span><span class="n">normalized_injection</span><span class="p">,</span>
                   <span class="n">normalized_projection</span><span class="o">=</span><span class="n">voxel_data</span><span class="o">.</span><span class="n">normalized_projection</span><span class="p">,</span>
                   <span class="n">flip_experiments</span><span class="o">=</span><span class="n">voxel_data</span><span class="o">.</span><span class="n">flip_experiments</span><span class="p">,</span>
                   <span class="n">data_mask_tolerance</span><span class="o">=</span><span class="n">voxel_data</span><span class="o">.</span><span class="n">data_mask_tolerance</span><span class="p">,</span>
                   <span class="n">injection_volume_bounds</span><span class="o">=</span><span class="n">voxel_data</span><span class="o">.</span><span class="n">injection_volume_bounds</span><span class="p">,</span>
                   <span class="n">projection_volume_bounds</span><span class="o">=</span><span class="n">voxel_data</span><span class="o">.</span><span class="n">projection_volume_bounds</span><span class="p">,</span>
                   <span class="n">min_contained_injection_ratio</span><span class="o">=</span><span class="n">voxel_data</span><span class="o">.</span><span class="n">min_contained_injection_ratio</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_unionize_experiment_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private helper method to unionize voxel scale data to regions.&quot;&quot;&quot;</span>
        <span class="n">injection_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">injection_mask</span><span class="o">.</span><span class="n">get_key</span><span class="p">()</span>
        <span class="n">projection_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_mask</span><span class="o">.</span><span class="n">get_key</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">injections</span> <span class="o">=</span> <span class="n">unionize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">injections</span><span class="p">,</span> <span class="n">injection_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projections</span> <span class="o">=</span> <span class="n">unionize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="p">,</span> <span class="n">projection_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="RegionalData.get_experiment_data"><a class="viewcode-back" href="../../../modules/generated/mcmodels.core.RegionalData.html#mcmodels.core.RegionalData.get_experiment_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_experiment_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_ids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pulls regionalized voxel-scale grid data for experiments.</span>

<span class="sd">        Uses the cache attribute to pull grid data from the Allen Brain Atlas.</span>
<span class="sd">        Note that only experiments passing all defined parameters will be</span>
<span class="sd">        included.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        experiment_ids : list</span>
<span class="sd">            Ids of candidate experiments to pull. Only the subset of these</span>
<span class="sd">            experiments passing user defined object parameters will be pulled.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : returns an instance of self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RegionalData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_experiment_data</span><span class="p">(</span><span class="n">experiment_ids</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unionize_experiment_data</span><span class="p">()</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/classes.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../whats_new.html">Release history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contrubuting</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/AllenInstitute/mouse_connectivity_models.git">Github Profile</a></li>
</ul>

<h3> Questions </h3>
<p class="questions">
  Send any questions using the <a href="http://alleninstitute.org/contact_us/index.html">Send Us a Message</a> link below, 
  or submit your question to <a href="http://stackoverflow.com/">StackOverflow</a> using with the 'allen-sdk' tag.
</p>

<p class="questions">
  If you encounter any problems using the AllenSDK, please create an issue on <a href="http://github.com/alleninstitute/allensdk/issues/">Github's issue tracker</a>.
</p>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>


    <div class="footer" role="contentinfo">
        &#169; Copyright 2018. Allen Institute..
    </div> 

  </body>
</html>